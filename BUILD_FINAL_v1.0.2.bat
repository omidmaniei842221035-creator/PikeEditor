@echo off
chcp 65001 >nul
title سامانه مانیتورینگ POS - نسخه 1.0.2
color 0A

echo.
echo ╔════════════════════════════════════════════════════════════════════╗
echo ║                                                                    ║
echo ║   ███████╗ ██████╗ ███████╗    ███╗   ███╗ ██████╗ ███╗   ██╗     ║
echo ║   ██╔══██║██╔═══██╗██╔════╝    ████╗ ████║██╔═══██╗████╗  ██║     ║
echo ║   ███████║██║   ██║███████╗    ██╔████╔██║██║   ██║██╔██╗ ██║     ║
echo ║   ██╔════╝██║   ██║╚════██║    ██║╚██╔╝██║██║   ██║██║╚██╗██║     ║
echo ║   ██║     ╚██████╔╝███████║    ██║ ╚═╝ ██║╚██████╔╝██║ ╚████║     ║
echo ║   ╚═╝      ╚═════╝ ╚══════╝    ╚═╝     ╚═╝ ╚═════╝ ╚═╝  ╚═══╝     ║
echo ║                                                                    ║
echo ║            سامانه مانیتورینگ هوشمند پایانه‌های فروشگاهی           ║
echo ║                    نسخه نهایی 1.0.2                               ║
echo ╚════════════════════════════════════════════════════════════════════╝
echo.

:: ═══════════════════════════════════════════════════════════════════
:: مرحله 0: پیش‌نیازها
:: ═══════════════════════════════════════════════════════════════════
echo [پیش‌نیازها] بررسی محیط...
echo.

where node >nul 2>&1
if errorlevel 1 (
    color 0C
    echo ❌ خطا: Node.js نصب نیست!
    echo.
    echo لطفاً از این لینک نصب کنید:
    echo https://nodejs.org/en/download/
    echo.
    pause
    exit /b 1
)

echo ✅ Node.js: 
node --version

echo ✅ npm:
npm --version
echo.

:: ═══════════════════════════════════════════════════════════════════
:: مرحله 1: پاکسازی نسخه قبلی
:: ═══════════════════════════════════════════════════════════════════
echo ═══════════════════════════════════════════════════════════════════
echo [مرحله 1/6] پاکسازی کامل...
echo ═══════════════════════════════════════════════════════════════════
echo.

if exist release (
    echo پاک کردن release...
    rmdir /s /q release 2>nul
)
if exist dist (
    echo پاک کردن dist...
    rmdir /s /q dist 2>nul
)
if exist dist-electron (
    echo پاک کردن dist-electron...
    rmdir /s /q dist-electron 2>nul
)

echo ✅ پاکسازی انجام شد
echo.

:: ═══════════════════════════════════════════════════════════════════
:: مرحله 2: نصب Dependencies (اگر لازم باشد)
:: ═══════════════════════════════════════════════════════════════════
echo ═══════════════════════════════════════════════════════════════════
echo [مرحله 2/6] بررسی Dependencies...
echo ═══════════════════════════════════════════════════════════════════
echo.

if not exist node_modules (
    echo نصب dependencies... (این کار 5-10 دقیقه طول می‌کشد)
    call npm install
    if errorlevel 1 (
        color 0C
        echo.
        echo ❌ خطا در نصب dependencies
        echo.
        echo اگر در ایران هستید، این دستورات را اجرا کنید:
        echo   npm config set registry https://registry.npmmirror.com
        echo   npm config set strict-ssl false
        echo.
        pause
        exit /b 1
    )
) else (
    echo ✅ Dependencies موجود است
)
echo.

:: ═══════════════════════════════════════════════════════════════════
:: مرحله 3: Build Frontend و Backend
:: ═══════════════════════════════════════════════════════════════════
echo ═══════════════════════════════════════════════════════════════════
echo [مرحله 3/6] Build Frontend و Backend...
echo ═══════════════════════════════════════════════════════════════════
echo.

call npm run build
if errorlevel 1 (
    color 0C
    echo.
    echo ❌ خطا در build
    pause
    exit /b 1
)

echo.
echo ✅ Build Frontend/Backend موفق
echo.

:: ═══════════════════════════════════════════════════════════════════
:: مرحله 4: Compile Electron
:: ═══════════════════════════════════════════════════════════════════
echo ═══════════════════════════════════════════════════════════════════
echo [مرحله 4/6] Compile Electron...
echo ═══════════════════════════════════════════════════════════════════
echo.

call npm run electron:compile
if errorlevel 1 (
    color 0C
    echo.
    echo ❌ خطا در compile Electron
    pause
    exit /b 1
)

echo.
echo ✅ Compile Electron موفق
echo.
echo فایل‌های ساخته شده:
dir /b dist-electron\*.cjs dist-electron\*.js 2>nul
echo.

:: ═══════════════════════════════════════════════════════════════════
:: مرحله 5: Build Windows Installer
:: ═══════════════════════════════════════════════════════════════════
echo ═══════════════════════════════════════════════════════════════════
echo [مرحله 5/6] ساخت Windows Installer...
echo ═══════════════════════════════════════════════════════════════════
echo.
echo ⏱️  این مرحله 5-10 دقیقه طول می‌کشد...
echo    لطفاً صبر کنید...
echo.

call npm run electron:build:win
if errorlevel 1 (
    color 0C
    echo.
    echo ❌ خطا در ساخت installer
    echo.
    echo راه‌حل‌های احتمالی:
    echo 1. Visual Studio Build Tools نصب شده؟
    echo 2. "Desktop development with C++" انتخاب شده؟
    echo.
    pause
    exit /b 1
)

echo.

:: ═══════════════════════════════════════════════════════════════════
:: مرحله 6: نمایش نتیجه
:: ═══════════════════════════════════════════════════════════════════
echo ═══════════════════════════════════════════════════════════════════
echo [مرحله 6/6] نتیجه Build
echo ═══════════════════════════════════════════════════════════════════
echo.

color 0A
echo.
echo ╔════════════════════════════════════════════════════════════════════╗
echo ║                                                                    ║
echo ║   ✅ ✅ ✅   BUILD موفقیت‌آمیز بود!   ✅ ✅ ✅                    ║
echo ║                                                                    ║
echo ╚════════════════════════════════════════════════════════════════════╝
echo.

echo فایل‌های ساخته شده در پوشه release:
echo ─────────────────────────────────────
dir /b release\*.exe 2>nul
echo.

echo ═══════════════════════════════════════════════════════════════════
echo مراحل نصب:
echo ═══════════════════════════════════════════════════════════════════
echo.
echo   1. به پوشه "release" بروید
echo.
echo   2. فایل "سامانه مانیتورینگ POS-Setup-1.0.2.exe" را پیدا کنید
echo.
echo   3. روی فایل راست‌کلیک کنید و "Run as administrator" را بزنید
echo.
echo   4. نصب را تکمیل کنید
echo.
echo   5. برنامه را از دسکتاپ یا منوی استارت اجرا کنید
echo.
echo ═══════════════════════════════════════════════════════════════════
echo.

:: Open release folder
start "" "release"

pause
